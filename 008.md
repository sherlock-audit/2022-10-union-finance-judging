CodingNameKiki

high

# Malicious staker can drain Union rewards from the Comptroller contract

## Summary
Malicious staker can drain Union rewards from the Comptroller contract

## Vulnerability Detail
Like described in the docs there are 3 types of stakes: “Free Stake”, “Utilized Stake”, “Defaulted Stake”.
The issue described here occurs with the "Free Stake". This type of stake can be withdrawn at any time by the staker and he receives earnings based on the amount he stakes. And these are staked funds that aren’t backing an active borrow.

When a user wants to stake his tokens, he calls the function `stake()`. After everything is done in the function, the staked tokens are deposited in the AssetManager contract and the user received his rewards based on the amount he staked.

https://github.com/sherlock-audit/2022-10-union-finance/blob/main/union-v2-contracts/contracts/user/UserManager.sol#L664-L681

However the problem here is that, the user can just call the function `unstake()` immediately and successfuly receive his tokens back.
The user received rewards based on the stake he made, regardless of the fact the he unstaked immediately after that. 
There is nothing preventing the user from just repeating this process and draining Union rewards from the Comptroller.

https://github.com/sherlock-audit/2022-10-union-finance/blob/main/union-v2-contracts/contracts/user/UserManager.sol#L691-L707

By following this scenario, a malicious staker can drain Union rewards.

## Impact
Duo to the issue described in "Vulnerability Detail", a malicious staker can take advantage of the "Free Stake" feature and successfuly drain rewards, by just staking and unstaking amount of tokens repeatedly.

## Code Snippet

https://github.com/sherlock-audit/2022-10-union-finance/blob/main/union-v2-contracts/contracts/user/UserManager.sol#L664-L682

https://github.com/sherlock-audit/2022-10-union-finance/blob/main/union-v2-contracts/contracts/user/UserManager.sol#L691-L708

## Tool used

Manual Review

## Recommendation
My recommendation is to add a time limit after the unstaking, so the same user can't stake again immediately. 
This fix won't be a problem if the user wants to stake more tokens, he can just call the function `stake()` and he will still receive rewards on the amount he staked more. The main problem here to fix is to prevent a staker from abusing the rewards, by just staking and unstaking his tokens.